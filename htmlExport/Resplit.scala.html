<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Resplit.scala</title>
<style type="text/css">
.s3{color:rgb(208,218,235);font-weight:normal;font-style:normal;}
.s18{color:rgb(255,198,109);font-weight:normal;font-style:normal;}
.s25{color:rgb(152,118,170);font-weight:normal;font-style:italic;}
.s22{color:rgb(173,100,190);font-weight:normal;font-style:normal;}
.s23{color:rgb(198,106,98);font-weight:normal;font-style:italic;}
.s7{color:rgb(136,198,155);font-weight:normal;font-style:normal;}
.s5{color:rgb(159,198,96);font-weight:normal;font-style:normal;}
.s8{color:rgb(209,207,187);font-weight:normal;font-style:normal;}
.s19{color:rgb(124,173,198);font-weight:normal;font-style:normal;}
.s6{color:rgb(255,198,109);font-weight:normal;font-style:normal;}
.s2{color:rgb(169,183,198);font-weight:normal;font-style:normal;}
.s15{color:rgb(0,184,187);font-weight:bold;font-style:normal;}
.s26{color:rgb(96,99,102);font-weight:normal;font-style:normal;}
.s11{color:rgb(0,0,0);background-color:rgb(59,81,77);font-weight:bold;font-style:normal;}
.s1{color:rgb(204,120,50);font-weight:normal;font-style:normal;}
.s20{color:rgb(119,183,103);font-weight:normal;font-style:normal;}
.s4{color:rgb(159,198,96);font-weight:normal;font-style:normal;}
.s12{color:rgb(98,151,85);font-weight:normal;font-style:italic;}
.s14{color:rgb(106,135,89);font-weight:normal;font-style:normal;}
.s13{color:rgb(255,198,109);font-weight:normal;font-style:normal;}
.s17{color:rgb(192,178,0);font-weight:normal;font-style:italic;}
.s24{color:rgb(124,173,198);background-color:rgb(82,80,58);font-weight:normal;font-style:normal;}
.s21{color:rgb(169,183,198);font-weight:normal;font-style:italic;}
.s16{color:rgb(128,128,128);font-weight:normal;font-style:normal;}
.s10{color:rgb(209,207,187);font-weight:normal;font-style:italic;}
.s9{color:rgb(104,151,187);font-weight:normal;font-style:normal;}
</style>
</head>
<body>
<pre style="color:rgb(0,0,0);font-weight:normal;font-style:normal;font-family:monospace;">
<span class="s26">1    </span><span class="s1">import</span> <span class="s2">cats</span>.<span class="s2">Applicative</span>
<span class="s26">2    </span><span class="s1">import</span> <span class="s2">cats</span>.<span class="s2">effect</span>.{<span class="s2">ExitCode</span><span class="s1">,</span> <span class="s2">IO</span><span class="s1">,</span> <span class="s2">IOApp</span>}
<span class="s26">3    </span><span class="s1">import</span> <span class="s2">fs2</span>.<span class="s2">io</span>.<span class="s2">file</span>.<span class="s2">Path</span>
<span class="s26">4    </span><span class="s1">import</span> <span class="s2">fs2</span>.{<span class="s2">Chunk</span><span class="s1">,</span> <span class="s2">Pull</span><span class="s1">,</span> <span class="s2">Stream</span>}
<span class="s26">5    </span><span class="s1">import</span> <span class="s2">scopt</span>.{<span class="s2">OParser</span><span class="s1">,</span> <span class="s3">OParserBuilder</span>}
<span class="s26">6    </span>
<span class="s26">7    </span><span class="s1">import</span> <span class="s2">java</span>.<span class="s2">io</span>.<span class="s3">File</span>
<span class="s26">8    </span><span class="s1">import</span> <span class="s2">scala</span>.<span class="s2">annotation</span>.<span class="s3">tailrec</span>
<span class="s26">9    </span><span class="s1">import</span> <span class="s2">scala</span>.<span class="s2">util</span>.<span class="s2">matching</span>.<span class="s2">Regex</span>
<span class="s26">10   </span>
<span class="s26">11   </span><span class="s1">object</span> <span class="s4">Resplit</span> {
<span class="s26">12   </span>
<span class="s26">13   </span>  <span class="s1">import</span> <span class="s2">cats</span>.<span class="s2">syntax</span>.<span class="s5">applicative</span>.*
<span class="s26">14   </span>  <span class="s1">import</span> <span class="s2">scala</span>.<span class="s2">util</span>.<span class="s5">chaining</span>.*
<span class="s26">15   </span>
<span class="s26">16   </span>  <span class="s1">def</span> <span class="s6">resplit</span>(<span class="s7">args</span>: <span class="s3">InputArgs</span>): <span class="s2">fs2</span>.<span class="s3">Stream</span>[<span class="s3">IO</span><span class="s1">,</span> (<span class="s3">Path</span><span class="s1">,</span> <span class="s3">Chunk</span>[<span class="s3">String</span>])] =
<span class="s26">17   </span>    <span class="s7">args</span>.<span class="s7">inputFileInsteadOfStdin</span>
<span class="s26">18   </span>      .<span class="s8">fold</span>(<span class="s7">ifEmpty</span> = <span class="s2">fs2</span>.<span class="s2">io</span>.<span class="s8">stdin</span>[<span class="s3">IO</span>](<span class="s7">bufSize</span> = <span class="s9">1024</span>)) {
<span class="s26">19   </span>        _.<span class="s8">getPath</span>
<span class="s26">20   </span>          .<span class="s8">pipe</span>(<span class="s5">Path</span>.<span class="s10">apply</span>)
<span class="s26">21   </span>          .<span class="s8">pipe</span>(<span class="s2">fs2</span>.<span class="s2">io</span>.<span class="s2">file</span>.<span class="s10">Files</span>[<span class="s3">IO</span>].<span class="s8">readAll</span>)
<span class="s26">22   </span>      }
<span class="s26">23   </span>      .<span class="s8">through</span>(<span class="s2">fs2</span>.<span class="s5">text</span>.<span class="s5">utf8</span>.<span class="s10">decode</span>)
<span class="s26">24   </span>      .<span class="s8">through</span>(<span class="s2">fs2</span>.<span class="s5">text</span>.<span class="s10">lines</span>)
<span class="s26">25   </span>      .<span class="s8">through</span> <span class="s11">{</span> <span class="s7">inputStream</span> =&gt;
<span class="s26">26   </span>        <span class="s1">if</span> (<span class="s7">args</span>.<span class="s7">suppressMatched</span>)
<span class="s26">27   </span>          <span class="s7">inputStream</span>.<span class="s8">split</span>(<span class="s7">thisLine</span> =&gt; <span class="s7">args</span>.<span class="s7">regexToMatch</span>.<span class="s8">matches</span>(<span class="s7">thisLine</span>))
<span class="s26">28   </span>        <span class="s1">else</span>
<span class="s26">29   </span>          <span class="s10">splitInclusive</span>(<span class="s7">inputStream</span>)(<span class="s7">thisLine</span> =&gt;
<span class="s26">30   </span>            <span class="s7">args</span>.<span class="s7">regexToMatch</span>.<span class="s8">matches</span>(<span class="s7">thisLine</span>)
<span class="s26">31   </span>          )
<span class="s26">32   </span>      <span class="s11">}</span>
<span class="s26">33   </span>      .<span class="s8">zipWithIndex</span>
<span class="s26">34   </span>      .<span class="s8">concurrently</span>(
<span class="s26">35   </span>        <span class="s10">createDirectoryOrDoNothing</span>(<span class="s7">args</span>.<span class="s7">outputDirectory</span>).<span class="s8">pipe</span>(<span class="s5">Stream</span>.<span class="s10">eval</span>)
<span class="s26">36   </span>      )
<span class="s26">37   </span>      .<span class="s8">map</span> { (<span class="s7">chunkOfLines</span><span class="s1">,</span> <span class="s7">chunkNumber</span>) =&gt;
<span class="s26">38   </span>        (
<span class="s26">39   </span>          <span class="s10">inferPathFromFirstMatchedLineOfChunk</span>(<span class="s7">args</span><span class="s1">,</span> <span class="s7">chunkOfLines</span><span class="s1">,</span> <span class="s7">chunkNumber</span>)<span class="s1">,</span>
<span class="s26">40   </span>          <span class="s7">chunkOfLines</span>
<span class="s26">41   </span>        )
<span class="s26">42   </span>      }
<span class="s26">43   </span>      .<span class="s8">evalTap</span> { (<span class="s7">path</span><span class="s1">,</span> <span class="s7">chunkOfLines</span>) =&gt;
<span class="s26">44   </span>        <span class="s10">writeChunkToPathAndPrint</span>(<span class="s7">chunkOfLines</span><span class="s1">,</span> <span class="s7">path</span><span class="s1">,</span> <span class="s7">args</span>.<span class="s7">silentMode</span>)
<span class="s26">45   </span>      }
<span class="s26">46   </span>
<span class="s26">47   </span>  <span class="s12">/** If the directory exists, return an empty effect Otherwise, go create it!</span>
<span class="s26">48   </span><span class="s12">    */</span>
<span class="s26">49   </span>  <span class="s1">def</span> <span class="s13">createDirectoryOrDoNothing</span>(<span class="s7">outputDirectory</span>: <span class="s3">Option</span>[<span class="s3">File</span>]): <span class="s3">IO</span>[<span class="s1">Unit</span>] =
<span class="s26">50   </span>    <span class="s7">outputDirectory</span>
<span class="s26">51   </span>      .<span class="s8">map</span>(_.<span class="s8">getPath</span>)
<span class="s26">52   </span>      .<span class="s8">map</span>(<span class="s5">Path</span>.<span class="s10">apply</span>)
<span class="s26">53   </span>      .<span class="s8">fold</span>(<span class="s7">ifEmpty</span> = <span class="s5">IO</span>.<span class="s10">unit</span>) { <span class="s7">dir</span> =&gt;
<span class="s26">54   </span>        <span class="s2">fs2</span>.<span class="s2">io</span>.<span class="s2">file</span>
<span class="s26">55   </span>          .<span class="s10">Files</span>[<span class="s3">IO</span>]
<span class="s26">56   </span>          .<span class="s8">exists</span>(<span class="s7">dir</span>)
<span class="s26">57   </span>          .<span class="s8">flatMap</span> { <span class="s7">exists</span> =&gt;
<span class="s26">58   </span>            <span class="s1">if</span> (<span class="s7">exists</span>) <span class="s5">IO</span>.<span class="s10">unit</span>
<span class="s26">59   </span>            <span class="s1">else</span>
<span class="s26">60   </span>              <span class="s2">fs2</span>.<span class="s2">io</span>.<span class="s2">file</span>
<span class="s26">61   </span>                .<span class="s10">Files</span>[<span class="s3">IO</span>]
<span class="s26">62   </span>                .<span class="s8">createDirectory</span>(<span class="s7">dir</span>)
<span class="s26">63   </span>          }
<span class="s26">64   </span>      }
<span class="s26">65   </span>
<span class="s26">66   </span>  <span class="s1">def</span> <span class="s13">writeChunkToPathAndPrint</span>(
<span class="s26">67   </span>      <span class="s7">c</span>: <span class="s3">Chunk</span>[<span class="s3">String</span>]<span class="s1">,</span>
<span class="s26">68   </span>      <span class="s7">path</span>: <span class="s3">Path</span><span class="s1">,</span>
<span class="s26">69   </span>      <span class="s7">isSilent</span>: <span class="s1">Boolean</span> = <span class="s1">false</span>
<span class="s26">70   </span>  ): <span class="s3">IO</span>[<span class="s1">Unit</span>] =
<span class="s26">71   </span>    <span class="s2">fs2</span>.<span class="s5">Stream</span>
<span class="s26">72   </span>      .<span class="s10">chunk</span>(<span class="s7">c</span>)
<span class="s26">73   </span>      .<span class="s8">intersperse</span>(<span class="s14">&quot;</span><span class="s1">\n</span><span class="s14">&quot;</span>)
<span class="s26">74   </span>      .<span class="s8">append</span>(<span class="s2">fs2</span>.<span class="s5">Stream</span>.<span class="s10">emit</span>(<span class="s14">&quot;</span><span class="s1">\n</span><span class="s14">&quot;</span>))
<span class="s26">75   </span>      .<span class="s8">through</span>(<span class="s2">fs2</span>.<span class="s5">text</span>.<span class="s5">utf8</span>.<span class="s10">encode</span>)
<span class="s26">76   </span>      .<span class="s8">through</span>(<span class="s2">fs2</span>.<span class="s2">io</span>.<span class="s2">file</span>.<span class="s10">Files</span>[<span class="s3">IO</span>].<span class="s8">writeAll</span>(<span class="s7">path</span>)(_))
<span class="s26">77   </span>      .<span class="s8">compile</span>
<span class="s26">78   </span>      .<span class="s8">drain</span>
<span class="s26">79   </span>      .<span class="s8">flatTap</span> { <span class="s7">_</span> =&gt;
<span class="s26">80   </span>        <span class="s1">if</span> (<span class="s7">isSilent</span>) <span class="s5">IO</span>.<span class="s10">unit</span>
<span class="s26">81   </span>        <span class="s1">else</span> <span class="s10">IO</span>(<span class="s5">Console</span>.<span class="s10">println</span>(<span class="s8">s</span><span class="s14">&quot;</span><span class="s15">$</span><span class="s7">path</span><span class="s1">\t</span><span class="s14">&quot;</span>))
<span class="s26">82   </span>      }
<span class="s26">83   </span>
<span class="s26">84   </span>  <span class="s16">// </span><span class="s17">TODO this is technically impure because is has a console printing effect in it</span>
<span class="s26">85   </span>  <span class="s1">def</span> <span class="s18">inferPathFromFirstMatchedLineOfChunk</span>(
<span class="s26">86   </span>      <span class="s7">args</span>: <span class="s3">InputArgs</span><span class="s1">,</span>
<span class="s26">87   </span>      <span class="s7">c</span>: <span class="s3">Chunk</span>[<span class="s3">String</span>]<span class="s1">,</span>
<span class="s26">88   </span>      <span class="s7">i</span>: <span class="s1">Long</span>
<span class="s26">89   </span>  ): <span class="s3">Path</span> = {
<span class="s26">90   </span>    <span class="s1">val</span> <span class="s19">fileContext</span>: <span class="s3">String</span> = <span class="s7">c</span>.<span class="s8">head</span>
<span class="s26">91   </span>      .<span class="s8">flatMap</span>(<span class="s7">args</span>.<span class="s7">regexToMatch</span>.<span class="s8">findFirstIn</span>(_))
<span class="s26">92   </span>      .<span class="s8">map</span> { <span class="s7">matchedChars</span> =&gt;
<span class="s26">93   </span>        <span class="s7">args</span>.<span class="s7">regexToSub</span>.<span class="s8">fold</span>(<span class="s7">ifEmpty</span> = <span class="s7">matchedChars</span>) { <span class="s7">providedRegexSub</span> =&gt;
<span class="s26">94   </span>          <span class="s1">try</span>
<span class="s26">95   </span>            <span class="s7">matchedChars</span>.<span class="s8">replaceFirst</span>(<span class="s7">args</span>.<span class="s7">regexToMatch</span>.<span class="s8">regex</span><span class="s1">,</span> <span class="s7">providedRegexSub</span>)
<span class="s26">96   </span>          <span class="s1">catch</span>
<span class="s26">97   </span>            <span class="s1">case</span> _ =&gt;
<span class="s26">98   </span>              <span class="s1">if</span> (<span class="s2">!</span><span class="s7">args</span>.<span class="s7">silentMode</span>)
<span class="s26">99   </span>                (<span class="s8">s</span><span class="s14">&quot;invalid regex: on </span><span class="s15">$</span><span class="s7">matchedChars</span><span class="s14"> &quot;</span> <span class="s2">+</span>
<span class="s26">100  </span>                  <span class="s8">s</span><span class="s14">&quot;for </span><span class="s15">$</span>{<span class="s7">args</span>.<span class="s7">regexToMatch</span>.<span class="s8">regex</span>}<span class="s14"> &quot;</span> <span class="s2">+</span>
<span class="s26">101  </span>                  <span class="s8">s</span><span class="s14">&quot;with substitution </span><span class="s15">$</span><span class="s7">providedRegexSub</span><span class="s14">&quot;</span>)
<span class="s26">102  </span>                  .<span class="s8">pipe</span>(<span class="s5">Console</span>.<span class="s10">err</span>.<span class="s8">println</span>)
<span class="s26">103  </span>              <span class="s14">&quot;&quot;</span>
<span class="s26">104  </span>        }
<span class="s26">105  </span>      }
<span class="s26">106  </span>      .<span class="s8">getOrElse</span>(<span class="s14">&quot;&quot;</span>)
<span class="s26">107  </span>    <span class="s1">val</span> <span class="s19">iii</span>: <span class="s3">String</span> = <span class="s10">leftPad</span>(<span class="s7">i</span>.<span class="s8">toString</span><span class="s1">,</span> <span class="s7">args</span>.<span class="s7">filenamePaddingDigits</span><span class="s1">,</span> <span class="s14">&#39;0&#39;</span>)
<span class="s26">108  </span>    <span class="s7">args</span>.<span class="s7">outputDirectory</span>
<span class="s26">109  </span>      .<span class="s8">fold</span>(<span class="s7">ifEmpty</span> = <span class="s5">Path</span>.<span class="s10">apply</span>(<span class="s8">s</span><span class="s14">&quot;</span><span class="s15">$</span>{<span class="s19">iii</span>}<span class="s14">_</span><span class="s15">$</span><span class="s19">fileContext</span><span class="s14">&quot;</span>)) { <span class="s7">dir</span> =&gt;
<span class="s26">110  </span>        <span class="s5">Path</span>.<span class="s10">apply</span>(<span class="s8">s</span><span class="s14">&quot;</span><span class="s15">$</span><span class="s7">dir</span><span class="s14">/</span><span class="s15">$</span>{<span class="s19">iii</span>}<span class="s14">_</span><span class="s15">$</span><span class="s19">fileContext</span><span class="s14">&quot;</span>)
<span class="s26">111  </span>      }
<span class="s26">112  </span>
<span class="s26">113  </span>  }
<span class="s26">114  </span>
<span class="s26">115  </span>  <span class="s1">def</span> <span class="s18">leftPad</span>(<span class="s7">s</span>: <span class="s3">String</span><span class="s1">,</span> <span class="s7">n</span>: <span class="s1">Int,</span> <span class="s7">c</span>: <span class="s1">Char</span>): <span class="s3">String</span> = <span class="s7">s</span>.<span class="s8">reverse</span>
<span class="s26">116  </span>    .<span class="s8">padTo</span>(<span class="s7">n</span><span class="s1">,</span> <span class="s7">c</span>)
<span class="s26">117  </span>    .<span class="s8">reverse</span>
<span class="s26">118  </span>
<span class="s26">119  </span>  <span class="s12">/** See </span><span class="s20">[[</span><span class="s21">fs2</span><span class="s12">.</span><span class="s21">Stream</span><span class="s12">.</span><span class="s10">split</span><span class="s20">]]</span>
<span class="s26">120  </span><span class="s12">    */</span>
<span class="s26">121  </span>  <span class="s1">def</span> <span class="s18">splitInclusive</span>[<span class="s22">F</span>[_]<span class="s1">,</span> <span class="s22">O</span>](
<span class="s26">122  </span>      <span class="s7">t</span>: <span class="s3">Stream</span>[<span class="s22">F</span><span class="s1">,</span> <span class="s22">O</span>]
<span class="s26">123  </span>  )(<span class="s7">f</span>: <span class="s22">O</span> =&gt; <span class="s1">Boolean</span>): <span class="s3">Stream</span>[<span class="s22">F</span><span class="s1">,</span> <span class="s3">Chunk</span>[<span class="s22">O</span>]] = {
<span class="s26">124  </span>    <span class="s1">def</span> <span class="s18">go</span>(<span class="s7">buffer</span>: <span class="s3">Chunk</span>[<span class="s22">O</span>]<span class="s1">,</span> <span class="s7">s</span>: <span class="s3">Stream</span>[<span class="s22">F</span><span class="s1">,</span> <span class="s22">O</span>]): <span class="s3">Pull</span>[<span class="s22">F</span><span class="s1">,</span> <span class="s3">Chunk</span>[<span class="s22">O</span>]<span class="s1">,</span> <span class="s1">Unit</span>] =
<span class="s26">125  </span>      <span class="s7">s</span>.<span class="s8">pull</span>.<span class="s8">uncons</span>.<span class="s8">flatMap</span> {
<span class="s26">126  </span>        <span class="s1">case</span> <span class="s3">Some</span>((<span class="s23">hd</span><span class="s1">,</span> <span class="s23">tl</span>)) =&gt;
<span class="s26">127  </span>          <span class="s23">hd</span>.<span class="s8">indexWhere</span>(<span class="s7">f</span>) <span class="s1">match</span> {
<span class="s26">128  </span>            <span class="s1">case</span> <span class="s5">None</span> =&gt; <span class="s3">go</span>(<span class="s7">buffer</span> <span class="s8">++</span> <span class="s23">hd</span><span class="s1">,</span> <span class="s23">tl</span>)
<span class="s26">129  </span>            <span class="s1">case</span> <span class="s3">Some</span>(<span class="s23">idx</span>) =&gt;
<span class="s26">130  </span>              <span class="s1">val</span> <span class="s24">pfx</span> = <span class="s23">hd</span>.<span class="s8">take</span>(<span class="s23">idx</span>)
<span class="s26">131  </span>              <span class="s1">val</span> <span class="s24">b2</span>  = <span class="s7">buffer</span> <span class="s8">++</span> <span class="s19">pfx</span>
<span class="s26">132  </span>
<span class="s26">133  </span>              <span class="s5">Pull</span>.<span class="s10">output1</span>(<span class="s19">b2</span>) <span class="s8">&gt;&gt;</span> <span class="s3">go</span>(
<span class="s26">134  </span>                <span class="s10">Chunk</span>(<span class="s23">hd</span>.<span class="s8">apply</span>(<span class="s23">idx</span>))<span class="s1">,</span>
<span class="s26">135  </span>                <span class="s23">tl</span>.<span class="s8">cons</span>(<span class="s23">hd</span>.<span class="s8">drop</span>(<span class="s23">idx</span> <span class="s2">+</span> <span class="s9">1</span>))
<span class="s26">136  </span>              )
<span class="s26">137  </span>          }
<span class="s26">138  </span>        <span class="s1">case</span> <span class="s5">None</span> =&gt;
<span class="s26">139  </span>          <span class="s1">if</span> (<span class="s7">buffer</span>.<span class="s8">nonEmpty</span>) <span class="s5">Pull</span>.<span class="s10">output1</span>(<span class="s7">buffer</span>)
<span class="s26">140  </span>          <span class="s1">else</span> <span class="s5">Pull</span>.<span class="s25">done</span>
<span class="s26">141  </span>      }
<span class="s26">142  </span>
<span class="s26">143  </span>    <span class="s3">go</span>(<span class="s5">Chunk</span>.<span class="s10">empty</span><span class="s1">,</span> <span class="s7">t</span>).<span class="s8">stream</span>
<span class="s26">144  </span>  }
<span class="s26">145  </span>}
<span class="s26">146  </span>
</pre>
</body>
</html>